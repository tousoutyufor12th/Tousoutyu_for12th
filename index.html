<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é€ƒèµ°ä¸­ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ </title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');

  body {
    font-family: 'Orbitron', system-ui, sans-serif;
    margin: 0;
    background: radial-gradient(circle at top, #111 0%, #000 70%);
    color: #fff;
    min-height: 100vh;
  }

  header {
    background: linear-gradient(90deg, #000, #222);
    display: flex;
    align-items: center;
    padding: 10px 16px;
    border-bottom: 2px solid red;
    cursor: pointer;
  }

  header img.logo {
    height: 38px;
    margin-right: 12px;
  }

  header h1 {
    font-size: 18px;
    letter-spacing: 1px;
    margin: 0;
    color: #ff3434;
    text-shadow: 0 0 8px #ff0000;
  }

  .btn {
    background: linear-gradient(180deg, #ff3b3b, #8b0000);
    color: #fff;
    border: 1px solid #660000;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    letter-spacing: 0.05em;
  }
  .btn:hover { opacity: 0.9; }

  .btn.secondary {
    background: #333;
    border: 1px solid #555;
  }

  main {
    padding: 20px;
  }

  .center {
    max-width: 900px;
    margin: 0 auto;
  }

  .panel {
    background: rgba(20,20,20,0.9);
    border: 2px solid #ff0000;
    box-shadow: 0 0 20px rgba(255,0,0,0.2);
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
  }

  input, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #555;
    background: #111;
    color: #fff;
    font-size: 15px;
  }

  h2 {
    color: #ff3434;
    text-shadow: 0 0 10px #ff0000;
  }

  label { font-size: 14px; color: #ccc; }

  .overlay {
    position: fixed; inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    background: rgba(0,0,0,0.8);
  }

  .popup {
    background: #111;
    border: 3px solid #ff0000;
    box-shadow: 0 0 30px red;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    max-width: 90%;
    color: #fff;
    position: relative;
  }

  .popup h2 {
    font-size: 32px;
    margin-bottom: 10px;
  }

  .popup p {
    font-size: 20px;
    color: #ffdddd;
  }

  .close {
    margin-top: 20px;
    background: #ff0000;
    border: none;
    color: #fff;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  #passwordModal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
  }

  #passwordBox {
    background: #111;
    border: 2px solid red;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    color: #fff;
  }

  #passwordBox input { margin-top: 10px; }

  #passwordError {
    color: #ff8080;
    margin-top: 8px;
    display: none;
  }

  #receiverPreview {
    margin-top: 30px;
    width: 100%;
    height: 400px;
    border: 2px solid #ff0000;
    border-radius: 10px;
  }

  #sentMessage {
    color: #00ff00;
    text-align: center;
    margin-top: 10px;
    display: none;
    text-shadow: 0 0 5px #00ff00;
  }
</style>
</head>

<body>
  <!-- ğŸ‘¥ æ¥ç¶šæ•°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="connectionStatus" style="position:fixed; top:10px; right:10px; background:#000000aa; color:white; padding:8px 12px; border-radius:6px; font-size:14px; z-index:999;">
  ğŸ‘¤ é…ä¿¡è€…: <span id="hostCount">0</span>ã€€ğŸ‘¥ å—ä¿¡è€…: <span id="viewerCount">0</span>
</div>
<header id="logoHeader">
  <img src="logo.PNG" class="logo" alt="ãƒ­ã‚´" />
  <h1>é€ƒèµ°ä¸­ é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ </h1>
</header>

<main>
  <div class="center">
    <section id="indexView" class="panel">
      <h2>ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
      <p>å‚åŠ ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
      <button id="toSender" class="btn">ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ã¸</button>
      <button id="toReceiver" class="btn secondary">é€ƒèµ°è€…ãƒšãƒ¼ã‚¸ã¸</button>
    </section>

    <section id="senderView" class="panel" style="display:none;">
      <h2>ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰</h2>
      <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰</label>
      <input id="titleInput" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
      <label style="margin-top:10px;">æœ¬æ–‡</label>
      <textarea id="messageInput" rows="4" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>
      <div style="margin-top:10px;">
        <button id="sendBtn" class="btn">é€ä¿¡</button>
      </div>
      <div id="sentMessage">é€ä¿¡ã—ã¾ã—ãŸï¼</div>

      <div style="margin-top:30px;">
        <h3 style="color:#ff3434;text-shadow:0 0 8px #ff0000;">é€ƒèµ°è€…ãƒ¢ãƒ¼ãƒ‰ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <iframe id="receiverPreview" title="é€ƒèµ°è€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"></iframe>
      </div>
    </section>

    <section id="receiverView" class="panel" style="display:none;">
      <h2>é€ƒèµ°è€…ãƒ¢ãƒ¼ãƒ‰</h2>
      <p>ã‚²ãƒ¼ãƒ ä¸­ã¯ç«¯æœ«ã®éŸ³é‡ã‚’æœ€å¤§ã«ã—ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</p>
      <button id="soundTestBtn" class="btn" style="margin-top:10px;">ğŸ”ˆ é€šçŸ¥éŸ³ãƒ†ã‚¹ãƒˆ</button>
<p id="soundStatus" style="color:#0f0; display:none; margin-top:8px;">é€šçŸ¥éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚</p>
    </section>
  </div>
</main>

<div id="overlay" class="overlay">
  <div class="popup">
    <h2 id="popupTitle"></h2>
    <p id="popupBody"></p>
    <button id="closePopup" class="close">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="passwordModal">
  <div id="passwordBox">
    <h2>ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <input id="passwordInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
    <div id="passwordError">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚</div>
    <div style="margin-top:10px;">
      <button id="passwordSubmit" class="btn">OK</button>
      <button id="passwordCancel" class="btn secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<audio id="alertSound" src="alarm.mp3" preload="auto"></audio>
  <audio id="testSound" src="message.mp3" preload="auto"></audio>

<!-- ğŸ”¥ Firebaseé€£æºã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onDisconnect, remove, onValue } 
  from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyDQ32VxTsd-8VvKXh6xtkrt4C_yqHNlNbM",
  authDomain: "tousoutyu-for-12th.firebaseapp.com",
  databaseURL: "https://tousoutyu-for-12th-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tousoutyu-for-12th",
  storageBucket: "tousoutyu-for-12th.firebasestorage.app",
  messagingSenderId: "130361498059",
  appId: "1:130361498059:web:0278dc6c06c245c1fcfe4e",
  measurementId: "G-7FZM01BVY2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
  // --- ğŸ‘¥ æ¥ç¶šæ•°ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ ---

// ã©ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸ã‹ã‚’è­˜åˆ¥ï¼ˆä¾‹: host.html ã¨ viewer.html ã§åˆ†ã‘ã‚‹ï¼‰
// --- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆç®¡ç†ç”¨ ---
let isHostPage = false; // åˆæœŸçŠ¶æ…‹ã§ã¯å—ä¿¡è€…ã¨ã¿ãªã™

const toSender = document.getElementById("toSender");
const toReceiver = document.getElementById("toReceiver");

// --- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼†æ¥ç¶šç™»éŒ²ã‚’ä¸€å…ƒåŒ– ---
const toSender = document.getElementById("toSender");
const toReceiver = document.getElementById("toReceiver");

let myConnectionRef = null; // æ¥ç¶šæƒ…å ±ã‚’ä¿æŒ

toSender.onclick = () => {
  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆé…ä¿¡è€…ï¼‰
  isHostPage = true;
  passwordModal.style.display = 'flex';
  passwordInput.value = '';
  passwordError.style.display = 'none';
  passwordInput.focus();

  // ã¾ã æ¥ç¶šç™»éŒ²ã—ã¦ã„ãªã‘ã‚Œã°è¿½åŠ 
  if (!myConnectionRef) {
    const connectionRef = ref(db, "connections/hosts");
    myConnectionRef = push(connectionRef, { connectedAt: Date.now() });
    onDisconnect(myConnectionRef).remove();
  }
};

toReceiver.onclick = () => {
  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆå—ä¿¡è€…ï¼‰
  isHostPage = false;
  show(receiverView);

  // ã¾ã æ¥ç¶šç™»éŒ²ã—ã¦ã„ãªã‘ã‚Œã°è¿½åŠ 
  if (!myConnectionRef) {
    const connectionRef = ref(db, "connections/viewers");
    myConnectionRef = push(connectionRef, { connectedAt: Date.now() });
    onDisconnect(myConnectionRef).remove();
  }
};

// äººæ•°ã‚«ã‚¦ãƒ³ãƒˆç”¨å‚ç…§
const hostRef = ref(db, "connections/hosts");
const viewerRef = ref(db, "connections/viewers");

const hostCountEl = document.getElementById("hostCount");
const viewerCountEl = document.getElementById("viewerCount");

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§äººæ•°ã‚’æ›´æ–°
onValue(hostRef, (snapshot) => {
  hostCountEl.textContent = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
});
onValue(viewerRef, (snapshot) => {
  viewerCountEl.textContent = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
});
  
passwordSubmit.onclick = () => {
  if (passwordInput.value === PASSWORD) {
    passwordModal.style.display = 'none';
    show(senderView);
    setupPreview();
  } else passwordError.style.display = 'block';
};
passwordCancel.onclick = () => passwordModal.style.display = 'none';

// ğŸ”¥ FirebaseçµŒç”±ã§é€ä¿¡
sendBtn.onclick = () => {
  const title = document.getElementById('titleInput').value.trim();
  const message = document.getElementById('messageInput').value.trim();
  if (!message) { alert("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

  // pushã§å±¥æ­´ã‚’è“„ç©
  push(ref(db, "broadcast/messages"), {
    title,
    message,
    timestamp: Date.now()
  });

  sentMessage.style.display = 'block';
  setTimeout(() => {
    sentMessage.style.display = 'none';
    document.getElementById('titleInput').value = '';
    document.getElementById('messageInput').value = '';
  }, 3000);
};

// ğŸ”¥ FirebaseçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡ï¼ˆ2æ®µéšé€šçŸ¥ + éŸ³å£°åˆ†é›¢ + å±¥æ­´å¯¾å¿œï¼‰
const messagesRef = ref(db, "broadcast/messages");
const alarmSound = document.getElementById("alertSound");   // alarm.mp3
const messageSound = document.getElementById("testSound");  // message.mp3

onChildAdded(messagesRef, (snapshot) => {
  const data = snapshot.val();
  if (!data) return;

  // --- ã‚¹ãƒ†ãƒƒãƒ—1: ã€Œæ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º ---
  popupTitle.textContent = "æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™";
  popupBody.innerHTML = `<button id="confirmNoticeBtn" class="btn" style="margin-top:15px;">é€šçŸ¥ã‚’ç¢ºèª</button>`;
  overlay.style.display = "flex";

  // ğŸ”Š alarm.mp3 å†ç”Ÿ
  try {
    alarmSound.currentTime = 0;
    alarmSound.play();
  } catch (e) {
    console.warn("alarm.mp3 å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:", e);
  }

  // --- ã‚¹ãƒ†ãƒƒãƒ—2: ã€Œé€šçŸ¥ã‚’ç¢ºèªã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ ---
  const confirmBtn = document.getElementById("confirmNoticeBtn");
  confirmBtn.onclick = async () => {
    try {
      // alarm.mp3 ã‚’åœæ­¢
      alarmSound.pause();
      alarmSound.currentTime = 0;

      // ğŸ”Š message.mp3 ã‚’å†ç”Ÿ
      messageSound.currentTime = 0;
      await messageSound.play();

      // æœ¬æ¥ã®é€šçŸ¥æœ¬æ–‡ã‚’è¡¨ç¤º
      popupTitle.textContent = data.title || "";
      popupBody.textContent = data.message || "";

      // å±¥æ­´è¿½åŠ 
      addToTimeline(data);
    } catch (e) {
      console.warn("message.mp3 å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:", e);
    }
  };
});
  
function setupPreview() {
  const html = `
  <!doctype html><html><head><meta charset='utf-8'/>
  <style>
    body{font-family:'Orbitron',system-ui,sans-serif;margin:0;background:radial-gradient(circle at top,#111 0%,#000 70%);color:#fff;text-align:center;min-height:100vh;}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.8);}
    .popup{background:#111;border:3px solid #ff0000;box-shadow:0 0 30px red;border-radius:12px;padding:40px;text-align:center;max-width:90%;color:#fff;position:relative;}
    .popup h2{font-size:32px;margin-bottom:10px;}
    .popup p{font-size:20px;color:#ffdddd;}
    .close{margin-top:20px;background:#ff0000;border:none;color:#fff;padding:10px 16px;border-radius:8px;font-weight:bold;cursor:pointer;}
  </style></head><body>
  <h2 style='color:#ff3434;text-shadow:0 0 10px #ff0000;'>é€ƒèµ°è€…ãƒ¢ãƒ¼ãƒ‰</h2>
  <p>é…ä¿¡ãŒã‚ã‚‹ã¨é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  <div id='overlay' class='overlay'>
    <div class='popup'>
      <h2 id='popupTitle'></h2>
      <p id='popupBody'></p>
      <button id='closePopup' class='close'>é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    const app = initializeApp(${JSON.stringify(firebaseConfig)});
    const db = getDatabase(app);
    const overlay = document.getElementById('overlay');
    const popupTitle = document.getElementById('popupTitle');
    const popupBody = document.getElementById('popupBody');
    const closePopup = document.getElementById('closePopup');
    const messagesRef = ref(db, "broadcast/messages");
    onChildAdded(messagesRef, (snapshot)=>{
      const data = snapshot.val();
      popupTitle.textContent = data.title||'';
      popupBody.textContent = data.message||'';
      overlay.style.display='flex';
    });
    closePopup.onclick=()=>overlay.style.display='none';
  <\/script></body></html>`;
  receiverPreview.srcdoc = html;
}

logoHeader.onclick = () => show(indexView);
closePopup.onclick = async () => {
  try {
    messageSound.currentTime = 0;
    await messageSound.play();
  } catch (e) {
    console.warn("é–‰ã˜ã‚‹æ™‚ã®éŸ³ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
  }
  overlay.style.display = 'none';
};
  // --- ğŸ”ˆ éŸ³å£°ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ + æ°¸ç¶šåŒ– ---
const soundTestBtn = document.getElementById('soundTestBtn');
const soundStatus = document.getElementById('soundStatus');

// 1ï¸âƒ£ ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰éŸ³ã‚’é³´ã‚‰ã™
soundTestBtn.onclick = async () => {
  try {
    await alertSound.play();
    localStorage.setItem("soundEnabled", "true");
    soundStatus.style.display = "block";
    soundStatus.textContent = "éŸ³å£°ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚";
  } catch (e) {
    soundStatus.style.display = "block";
    soundStatus.style.color = "#ff8080";
    soundStatus.textContent = "éŸ³ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ“ä½œã‚’å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
  }
};

// 2ï¸âƒ£ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨±å¯æƒ…å ±ãŒã‚ã‚Œã°è‡ªå‹•å†ç”Ÿã‚’è©¦è¡Œ
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("soundEnabled") === "true") {
    alertSound.play().catch(() => {
      console.log("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
    });
  }
});
</script>
</body>
</html>
